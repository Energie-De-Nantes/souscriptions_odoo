<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Template de facture personnalisé pour l'électricité -->
    <template id="report_facture_energie">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-if="o.is_facture_energie">
                    <t t-call="web.external_layout">
                        <div class="page">
                            <!-- En-tête énergie -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div style="background-color: #2E7D32; color: white; padding: 10px; text-align: center; border-radius: 5px;">
                                        <h3 class="mb-0">
                                            ⚡ Facture d'Électricité
                                        </h3>
                                    </div>
                                </div>
                            </div>

                            <!-- Informations souscription -->
                            <div t-if="o.souscription_id" class="row mb-4">
                                <div class="col-12">
                                    <div style="background-color: #E8F5E8; padding: 15px; border-radius: 5px; border-left: 4px solid #2E7D32;">
                                        <h5 style="color: #2E7D32; margin-bottom: 10px;">
                                            Informations Souscription
                                        </h5>
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>Référence contrat:</strong> <span t-field="o.souscription_id.name"/><br/>
                                                <strong>Point de livraison (PDL):</strong> <span t-field="o.souscription_id.pdl"/><br/>
                                                <strong>Puissance souscrite:</strong> <span t-field="o.souscription_id.puissance_souscrite"/> kVA
                                            </div>
                                            <div class="col-6">
                                                <strong>Type de tarif:</strong> 
                                                <span t-if="o.souscription_id.type_tarif == 'base'">Base</span>
                                                <span t-elif="o.souscription_id.type_tarif == 'hphc'">Heures Pleines / Heures Creuses</span>
                                                <span t-else="" t-field="o.souscription_id.type_tarif"/><br/>
                                                <strong>Période facturée:</strong> <span t-field="o.periode_id.mois_annee"/><br/>
                                                <strong>Référence compteur:</strong> <span t-field="o.souscription_id.ref_compteur"/>
                                            </div>
                                        </div>
                                        <div t-if="o.souscription_id.tarif_solidaire" class="mt-2">
                                            <span class="badge" style="background-color: #2E7D32; color: white;">
                                                ♥ Tarif Solidaire
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <!-- Informations client et facture -->
                            <div class="row">
                                <div class="col-6">
                                    <strong>Client:</strong>
                                    <div t-field="o.partner_id" t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
                                </div>
                                <div class="col-6">
                                    <strong>Numéro de facture:</strong> <span t-field="o.name"/><br/>
                                    <strong>Date de facture:</strong> <span t-field="o.invoice_date"/><br/>
                                    <strong>Date d'échéance:</strong> <span t-field="o.invoice_date_due"/>
                                </div>
                            </div>

                            <!-- Lignes de facture -->
                            <table class="table table-sm o_main_table mt-4">
                                <thead>
                                    <tr>
                                        <th style="color: #2E7D32;">Description</th>
                                        <th class="text-end">Quantité</th>
                                        <th class="text-end">Prix unitaire</th>
                                        <th class="text-end">Montant</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="o.invoice_line_ids" t-as="line">
                                        <tr t-if="line.display_type == 'line_section'" style="background-color: #E8F5E8;">
                                            <td colspan="4"><strong t-field="line.name"/></td>
                                        </tr>
                                        <tr t-elif="line.display_type == 'line_note'">
                                            <td colspan="4" class="text-muted" style="font-style: italic;">
                                                <span t-field="line.name"/>
                                            </td>
                                        </tr>
                                        <tr t-else="">
                                            <td><span t-field="line.name"/></td>
                                            <td class="text-end"><span t-field="line.quantity"/></td>
                                            <td class="text-end"><span t-field="line.price_unit"/></td>
                                            <td class="text-end"><span t-field="line.price_subtotal"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>

                            <!-- Totaux -->
                            <div class="clearfix">
                                <div class="row">
                                    <div class="col-6">
                                        <!-- Note TURPE -->
                                        <div class="mt-3 p-3" style="background-color: #f8f9fa; border-left: 3px solid #2E7D32;">
                                            <p class="mb-0">
                                                <strong style="color: #2E7D32;">Information réglementaire :</strong><br/>
                                                Les montants TURPE (Tarif d'Utilisation des Réseaux Publics d'Électricité) 
                                                correspondent aux coûts d'acheminement de l'électricité et sont indiqués à titre informatif.
                                            </p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <table class="table table-sm">
                                            <tr>
                                                <td><strong>Sous-total HT</strong></td>
                                                <td class="text-end"><span t-field="o.amount_untaxed"/></td>
                                            </tr>
                                            <tr t-if="o.amount_tax">
                                                <td>TVA</td>
                                                <td class="text-end"><span t-field="o.amount_tax"/></td>
                                            </tr>
                                            <tr class="border-black">
                                                <td><strong>Total TTC</strong></td>
                                                <td class="text-end"><strong><span t-field="o.amount_total"/></strong></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Pied de page énergie -->
                            <div class="mt-4 text-center" style="color: #2E7D32;">
                                <small>
                                    Service Client Énergie : 0800 XXX XXX | energie@example.com
                                </small>
                            </div>

                        </div>
                    </t>
                </t>
                <t t-else="">
                    <!-- Utiliser le template standard pour les autres factures -->
                    <t t-call="account.report_invoice_document"/>
                </t>
            </t>
        </t>
    </template>

    <!-- Action de rapport pour les factures d'énergie -->
    <record id="action_report_facture_energie" model="ir.actions.report">
        <field name="name">Facture d'Électricité</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">souscriptions_odoo.report_facture_energie</field>
        <field name="report_file">Facture_Energie</field>
        <field name="print_report_name">'Facture_Energie_%s' % (object.name)</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
        <field name="groups_id" eval="[(4, ref('base.group_user'))]"/>
    </record>

</odoo>