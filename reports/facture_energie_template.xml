<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Template de facture personnalis√© pour l'√©lectricit√© -->
    <template id="report_facture_energie">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="o">
                <t t-if="o.is_facture_energie">
                    <t t-call="web.external_layout">
                        <div class="page">
                            <!-- En-t√™te √©nergie -->
                            <div class="row mb-3">
                                <div class="col-12">
                                    <div style="background-color: #2E7D32; color: white; padding: 10px; text-align: center; border-radius: 5px;">
                                        <h3 class="mb-0">
                                            ‚ö° Facture d'√âlectricit√©
                                        </h3>
                                    </div>
                                </div>
                            </div>

                            <!-- Informations souscription -->
                            <div t-if="o.souscription_id" class="row mb-4">
                                <div class="col-12">
                                    <div style="background-color: #E8F5E8; padding: 15px; border-radius: 5px; border-left: 4px solid #2E7D32;">
                                        <h5 style="color: #2E7D32; margin-bottom: 10px;">
                                            Informations Souscription
                                        </h5>
                                        <div class="row">
                                            <div class="col-6">
                                                <strong>R√©f√©rence contrat:</strong> <span t-field="o.souscription_id.name"/><br/>
                                                <strong>Point de livraison (PDL):</strong> <span t-field="o.souscription_id.pdl"/><br/>
                                                <strong>Puissance souscrite:</strong> <span t-field="o.souscription_id.puissance_souscrite"/> kVA
                                            </div>
                                            <div class="col-6">
                                                <strong>Type de tarif:</strong> 
                                                <span t-if="o.souscription_id.type_tarif == 'base'">Base</span>
                                                <span t-elif="o.souscription_id.type_tarif == 'hphc'">Heures Pleines / Heures Creuses</span>
                                                <span t-else="" t-field="o.souscription_id.type_tarif"/><br/>
                                                <strong>P√©riode factur√©e:</strong> <span t-field="o.periode_id.mois_annee"/><br/>
                                                <strong>R√©f√©rence compteur:</strong> <span t-field="o.souscription_id.ref_compteur"/>
                                            </div>
                                        </div>
                                        <div t-if="o.souscription_id.tarif_solidaire" class="mt-2">
                                            <span class="badge" style="background-color: #2E7D32; color: white;">
                                                ‚ô• Tarif Solidaire
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Historique de consommation (graphique) -->
                            <t t-set="consumption_data" t-value="o.get_historical_consumption_data()"/>
                            <div t-if="consumption_data.get('has_data')" class="row mb-4">
                                <div class="col-12">
                                    <div style="background-color: #F5F7FA; padding: 15px; border-radius: 5px; border-left: 4px solid #2E7D32;">
                                        <h5 style="color: #2E7D32; margin-bottom: 15px;">
                                            üìä Historique de consommation (12 derniers mois)
                                        </h5>
                                        <div style="height: 300px; position: relative;">
                                            <canvas id="consumptionChart" width="800" height="300"></canvas>
                                        </div>
                                        <p class="text-muted text-center mt-2 mb-0" style="font-size: 0.85em;">
                                            Consommation en kWh sur <span t-esc="consumption_data.get('nb_periodes')"/> p√©riode(s)
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <!-- Informations client et facture -->
                            <div class="row">
                                <div class="col-6">
                                    <strong>Client:</strong>
                                    <div t-field="o.partner_id" t-options='{"widget": "contact", "fields": ["address", "name"], "no_marker": True}'/>
                                </div>
                                <div class="col-6">
                                    <strong>Num√©ro de facture:</strong> <span t-field="o.name"/><br/>
                                    <strong>Date de facture:</strong> <span t-field="o.invoice_date"/><br/>
                                    <strong>Date d'√©ch√©ance:</strong> <span t-field="o.invoice_date_due"/>
                                </div>
                            </div>

                            <!-- Lignes de facture -->
                            <table class="table table-sm o_main_table mt-4">
                                <thead>
                                    <tr>
                                        <th style="color: #2E7D32;">Description</th>
                                        <th class="text-end">Quantit√©</th>
                                        <th class="text-end">Prix unitaire</th>
                                        <th class="text-end">Montant</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <t t-foreach="o.invoice_line_ids" t-as="line">
                                        <tr t-if="line.display_type == 'line_section'" style="background-color: #E8F5E8;">
                                            <td colspan="4"><strong t-field="line.name"/></td>
                                        </tr>
                                        <tr t-elif="line.display_type == 'line_note'">
                                            <td colspan="4" class="text-muted" style="font-style: italic;">
                                                <span t-field="line.name"/>
                                            </td>
                                        </tr>
                                        <tr t-else="">
                                            <td><span t-field="line.name"/></td>
                                            <td class="text-end"><span t-field="line.quantity"/></td>
                                            <td class="text-end"><span t-field="line.price_unit"/></td>
                                            <td class="text-end"><span t-field="line.price_subtotal"/></td>
                                        </tr>
                                    </t>
                                </tbody>
                            </table>

                            <!-- Totaux -->
                            <div class="clearfix">
                                <div class="row">
                                    <div class="col-6">
                                        <!-- Note TURPE -->
                                        <div class="mt-3 p-3" style="background-color: #f8f9fa; border-left: 3px solid #2E7D32;">
                                            <p class="mb-0">
                                                <strong style="color: #2E7D32;">Information r√©glementaire :</strong><br/>
                                                Les montants TURPE (Tarif d'Utilisation des R√©seaux Publics d'√âlectricit√©) 
                                                correspondent aux co√ªts d'acheminement de l'√©lectricit√© et sont indiqu√©s √† titre informatif.
                                            </p>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <table class="table table-sm">
                                            <tr>
                                                <td><strong>Sous-total HT</strong></td>
                                                <td class="text-end"><span t-field="o.amount_untaxed"/></td>
                                            </tr>
                                            <tr t-if="o.amount_tax">
                                                <td>TVA</td>
                                                <td class="text-end"><span t-field="o.amount_tax"/></td>
                                            </tr>
                                            <tr class="border-black">
                                                <td><strong>Total TTC</strong></td>
                                                <td class="text-end"><strong><span t-field="o.amount_total"/></strong></td>
                                            </tr>
                                        </table>
                                    </div>
                                </div>
                            </div>

                            <!-- Pied de page √©nergie -->
                            <div class="mt-4 text-center" style="color: #2E7D32;">
                                <small>
                                    Service Client √ânergie : 0800 XXX XXX | energie@example.com
                                </small>
                            </div>

                            <!-- Chart.js Integration -->
                            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
                            <script t-if="consumption_data.get('has_data')">
                                document.addEventListener('DOMContentLoaded', function() {
                                    var ctx = document.getElementById('consumptionChart');
                                    if (!ctx) return;
                                    
                                    var ctx2d = ctx.getContext('2d');
                                    var chartData = <t t-out="o.get_historical_consumption_data_json()"/>;
                                    
                                    var datasets = [];
                                    var colors = {
                                        base: '#2E7D32',     // Vert principal
                                        hp: '#43A047',       // Vert HP
                                        hc: '#66BB6A'        // Vert HC plus clair
                                    };
                                    
                                    if (chartData.type_tarif === 'base') {
                                        datasets.push({
                                            label: 'Consommation Base (kWh)',
                                            data: chartData.data_base,
                                            backgroundColor: colors.base,
                                            borderColor: colors.base,
                                            borderWidth: 1
                                        });
                                    } else {
                                        datasets.push({
                                            label: 'Heures Pleines (kWh)',
                                            data: chartData.data_hp,
                                            backgroundColor: colors.hp,
                                            borderColor: colors.hp,
                                            borderWidth: 1
                                        });
                                        datasets.push({
                                            label: 'Heures Creuses (kWh)',
                                            data: chartData.data_hc,
                                            backgroundColor: colors.hc,
                                            borderColor: colors.hc,
                                            borderWidth: 1
                                        });
                                    }
                                    
                                    new Chart(ctx2d, {
                                        type: 'bar',
                                        data: {
                                            labels: chartData.labels,
                                            datasets: datasets
                                        },
                                        options: {
                                            responsive: true,
                                            maintainAspectRatio: false,
                                            scales: {
                                                y: {
                                                    beginAtZero: true,
                                                    title: {
                                                        display: true,
                                                        text: 'Consommation (kWh)',
                                                        color: '#2E7D32',
                                                        font: { weight: 'bold' }
                                                    },
                                                    grid: { color: '#E8F5E8' }
                                                },
                                                x: {
                                                    title: {
                                                        display: true,
                                                        text: 'P√©riode',
                                                        color: '#2E7D32',
                                                        font: { weight: 'bold' }
                                                    },
                                                    grid: { color: '#E8F5E8' }
                                                }
                                            },
                                            plugins: {
                                                legend: {
                                                    display: chartData.type_tarif !== 'base',
                                                    position: 'top',
                                                    labels: { color: '#2E7D32' }
                                                },
                                                tooltip: {
                                                    backgroundColor: 'rgba(46, 125, 50, 0.9)',
                                                    titleColor: 'white',
                                                    bodyColor: 'white',
                                                    callbacks: {
                                                        label: function(context) {
                                                            return context.dataset.label + ': ' + context.parsed.y + ' kWh';
                                                        }
                                                    }
                                                }
                                            }
                                        }
                                    });
                                });
                            </script>
                        </div>
                    </t>
                </t>
                <t t-else="">
                    <!-- Utiliser le template standard pour les autres factures -->
                    <t t-call="account.report_invoice_document"/>
                </t>
            </t>
        </t>
    </template>

    <!-- Action de rapport pour les factures d'√©nergie -->
    <record id="action_report_facture_energie" model="ir.actions.report">
        <field name="name">Facture d'√âlectricit√©</field>
        <field name="model">account.move</field>
        <field name="report_type">qweb-pdf</field>
        <field name="report_name">souscriptions.report_facture_energie</field>
        <field name="report_file">Facture_Energie</field>
        <field name="print_report_name">'Facture_Energie_%s' % (object.name)</field>
        <field name="binding_model_id" ref="account.model_account_move"/>
        <field name="binding_type">report</field>
        <field name="groups_id" eval="[(4, ref('base.group_user'))]"/>
    </record>

</odoo>